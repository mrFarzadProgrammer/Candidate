<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø´Ø§Ø±Ú©Øª - {{ contribution.tracking_code }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modern-admin.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='fonts/fontawesome/all.min.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="dashboard-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-user-tie" style="font-size: 40px;"></i>
                </div>
                <h2>Ù¾Ù†Ù„ Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡</h2>
                <p>{{ session.get('candidate_name', 'Ù†Ø§Ù…Ø²Ø¯') }}</p>
            </div>
            
            <nav class="sidebar-menu">
                <a href="{{ url_for('dashboard') }}" class="menu-item">
                    <i class="fas fa-home"></i>
                    <span>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span>
                </a>
                <a href="{{ url_for('contributions') }}" class="menu-item active">
                    <i class="fas fa-users"></i>
                    <span>Ù…Ø´Ø§Ø±Ú©Øª Ø´Ù‡Ø±ÙˆÙ†Ø¯ÛŒ</span>
                </a>
                <a href="{{ url_for('leaderboard') }}" class="menu-item">
                    <i class="fas fa-trophy"></i>
                    <span>Ø¬Ø¯ÙˆÙ„ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª</span>
                </a>
                <a href="{{ url_for('logout') }}" class="menu-item" style="margin-top: auto;">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Ø®Ø±ÙˆØ¬</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-header">
                <h1>ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø´Ø§Ø±Ú©Øª</h1>
            </div>

<div class="container-fluid py-4" dir="rtl">
    
    <!-- Ù‡Ø¯Ø± -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3>ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø´Ø§Ø±Ú©Øª</h3>
            <p class="text-muted mb-0">Ú©Ø¯ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ: <strong>{{ contribution.tracking_code }}</strong></p>
        </div>
        <a href="{{ url_for('contributions') }}" class="btn btn-secondary">
            â† Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª
        </a>
    </div>
    
    <div class="row">
        <!-- Ø³ØªÙˆÙ† Ø§ØµÙ„ÛŒ -->
        <div class="col-lg-8">
            
            <!-- Ú©Ø§Ø±Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØµÙ„ÛŒ -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            {% if contribution.contribution_type == 'idea' %}
                            <span class="badge bg-light text-dark">ğŸ’¡ Ø§ÛŒØ¯Ù‡</span>
                            {% else %}
                            <span class="badge bg-warning">ğŸ“£ Ù…Ø´Ú©Ù„</span>
                            {% endif %}
                            
                            {% if contribution.category == 'education' %}
                            <span class="badge bg-light text-dark">ğŸ“š Ø¢Ù…ÙˆØ²Ø´</span>
                            {% elif contribution.category == 'health' %}
                            <span class="badge bg-light text-dark">ğŸ¥ Ø¨Ù‡Ø¯Ø§Ø´Øª</span>
                            {% elif contribution.category == 'traffic' %}
                            <span class="badge bg-light text-dark">ğŸš— ØªØ±Ø§ÙÛŒÚ©</span>
                            {% elif contribution.category == 'security' %}
                            <span class="badge bg-light text-dark">ğŸ›¡ï¸ Ø§Ù…Ù†ÛŒØª</span>
                            {% elif contribution.category == 'environment' %}
                            <span class="badge bg-light text-dark">ğŸŒ³ Ù…Ø­ÛŒØ· Ø²ÛŒØ³Øª</span>
                            {% elif contribution.category == 'cultural' %}
                            <span class="badge bg-light text-dark">ğŸ­ ÙØ±Ù‡Ù†Ú¯ÛŒ</span>
                            {% elif contribution.category == 'infrastructure' %}
                            <span class="badge bg-light text-dark">ğŸ—ï¸ Ø²ÛŒØ±Ø³Ø§Ø®Øª</span>
                            {% elif contribution.category == 'economic' %}
                            <span class="badge bg-light text-dark">ğŸ’° Ø§Ù‚ØªØµØ§Ø¯</span>
                            {% elif contribution.category == 'welfare' %}
                            <span class="badge bg-light text-dark">ğŸ¤ Ø±ÙØ§Ù‡</span>
                            {% else %}
                            <span class="badge bg-light text-dark">ğŸ“‹ Ø³Ø§ÛŒØ±</span>
                            {% endif %}
                        </div>
                        
                        <div>
                            {% if contribution.status == 'pending' %}
                            <span class="badge bg-warning">â³ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø±Ø³ÛŒ</span>
                            {% elif contribution.status == 'under_review' %}
                            <span class="badge bg-info">ğŸ‘€ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ</span>
                            {% elif contribution.status == 'approved' %}
                            <span class="badge bg-success">âœ… ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡</span>
                            {% elif contribution.status == 'in_progress' %}
                            <span class="badge bg-primary">ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</span>
                            {% elif contribution.status == 'completed' %}
                            <span class="badge bg-success">âœ”ï¸ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</span>
                            {% elif contribution.status == 'rejected' %}
                            <span class="badge bg-danger">âŒ Ø±Ø¯ Ø´Ø¯Ù‡</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="card-body">
                    <h4 class="mb-3">{{ contribution.title }}</h4>
                    <p class="lead">{{ contribution.description }}</p>
                    
                    <!-- ØªØµØ§ÙˆÛŒØ± -->
                    {% if contribution.images %}
                    <div class="mb-4">
                        <h6>ğŸ–¼ï¸ ØªØµØ§ÙˆÛŒØ± Ù¾ÛŒÙˆØ³Øª:</h6>
                        <div class="row g-2">
                            {% for image in contribution.images %}
                            <div class="col-md-4">
                                <a href="{{ url_for('static', filename='uploads/contributions/' + image) }}" target="_blank">
                                    <img src="{{ url_for('static', filename='uploads/contributions/' + image) }}" 
                                         class="img-fluid rounded shadow-sm" alt="ØªØµÙˆÛŒØ± Ù…Ø´Ø§Ø±Ú©Øª">
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ -->
                    {% if contribution.location_text or (contribution.latitude and contribution.longitude) %}
                    <div class="alert alert-info">
                        <h6>ğŸ“ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ:</h6>
                        {% if contribution.location_text %}
                        <p class="mb-1"><strong>Ø¢Ø¯Ø±Ø³:</strong> {{ contribution.location_text }}</p>
                        {% endif %}
                        
                        {% if contribution.latitude and contribution.longitude %}
                        <p class="mb-1"><strong>Ù…Ø®ØªØµØ§Øª:</strong> {{ contribution.latitude }}, {{ contribution.longitude }}</p>
                        <a href="https://www.google.com/maps?q={{ contribution.latitude }},{{ contribution.longitude }}" 
                           target="_blank" class="btn btn-sm btn-primary mt-2">
                            ğŸ—ºï¸ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø± Ù†Ù‚Ø´Ù‡
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Ø¢Ù…Ø§Ø± -->
                    <div class="d-flex justify-content-around py-3 border-top border-bottom my-3">
                        <div class="text-center">
                            <h5 class="text-primary mb-0">{{ contribution.votes_count }}</h5>
                            <small class="text-muted">ğŸ‘ Ø±Ø§ÛŒ</small>
                        </div>
                        <div class="text-center">
                            <h5 class="text-info mb-0">{{ contribution.comments_count }}</h5>
                            <small class="text-muted">ğŸ’¬ Ù†Ø¸Ø±</small>
                        </div>
                        <div class="text-center">
                            <h5 class="text-success mb-0">{{ contribution.views_count }}</h5>
                            <small class="text-muted">ğŸ‘ï¸ Ø¨Ø§Ø²Ø¯ÛŒØ¯</small>
                        </div>
                    </div>
                    
                    <!-- Ù¾Ø§Ø³Ø® Ù…Ø¯ÛŒØ± -->
                    {% if contribution.admin_response %}
                    <div class="alert alert-success mt-3">
                        <h6>âœ‰ï¸ Ù¾Ø§Ø³Ø®:</h6>
                        <p class="mb-0">{{ contribution.admin_response }}</p>
                        <small class="text-muted">{{ contribution.response_date.strftime('%Y/%m/%d %H:%M') }}</small>
                    </div>
                    {% endif %}
                </div>
                
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Ø§Ø±Ø³Ø§Ù„â€ŒÚ©Ù†Ù†Ø¯Ù‡:</strong> {{ contribution.user_first_name }} {{ contribution.user_last_name or '' }}
                            {% if contribution.user_username %}
                            <span class="text-muted">(@{{ contribution.user_username }})</span>
                            {% endif %}
                        </div>
                        <div class="text-muted">
                            <small>ğŸ“… {{ contribution.created_at.strftime('%Y/%m/%d %H:%M') }}</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ù†Ø¸Ø±Ø§Øª -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ’¬ Ù†Ø¸Ø±Ø§Øª ({{ contribution.comments_count }})</h5>
                </div>
                <div class="card-body">
                    {% if comments %}
                        {% for comment in comments %}
                        <div class="border-bottom pb-3 mb-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>{{ comment.user_name }}</strong>
                                    <p class="mb-1 mt-2">{{ comment.comment_text }}</p>
                                </div>
                                <small class="text-muted">{{ comment.created_at.strftime('%Y/%m/%d %H:%M') }}</small>
                            </div>
                            
                            <!-- Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ -->
                            {% if comment.replies %}
                            <div class="ms-4 mt-2">
                                {% for reply in comment.replies %}
                                <div class="border-start border-3 ps-3 mt-2">
                                    <strong class="small">{{ reply.user_name }}</strong>
                                    <p class="small mb-1">{{ reply.comment_text }}</p>
                                    <small class="text-muted">{{ reply.created_at.strftime('%Y/%m/%d %H:%M') }}</small>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center mb-0">Ù‡Ù†ÙˆØ² Ù†Ø¸Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
                    {% endif %}
                </div>
            </div>
            
        </div>
        
        <!-- Ø³ØªÙˆÙ† Ú©Ù†Ø§Ø±ÛŒ - Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø¯ÛŒØ±ÛŒØªÛŒ -->
        <div class="col-lg-4">
            
            <!-- ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª -->
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <h6 class="mb-0">âš™ï¸ ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª</h6>
                </div>
                <div class="card-body">
                    <form method="post" action="{{ url_for('update_contribution_status', contribution_id=contribution.id) }}">
                        <div class="mb-3">
                            <label class="form-label">ÙˆØ¶Ø¹ÛŒØª Ø¬Ø¯ÛŒØ¯</label>
                            <select name="status" class="form-select" required>
                                <option value="pending" {% if contribution.status == 'pending' %}selected{% endif %}>â³ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</option>
                                <option value="under_review" {% if contribution.status == 'under_review' %}selected{% endif %}>ğŸ‘€ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ</option>
                                <option value="approved" {% if contribution.status == 'approved' %}selected{% endif %}>âœ… ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡</option>
                                <option value="in_progress" {% if contribution.status == 'in_progress' %}selected{% endif %}>ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</option>
                                <option value="completed" {% if contribution.status == 'completed' %}selected{% endif %}>âœ”ï¸ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</option>
                                <option value="rejected" {% if contribution.status == 'rejected' %}selected{% endif %}>âŒ Ø±Ø¯ Ø´Ø¯Ù‡</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
                    </form>
                </div>
            </div>
            
            <!-- Ø¹Ù…Ù„ÛŒØ§Øª Ø³Ø±ÛŒØ¹ -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">âš¡ Ø¹Ù…Ù„ÛŒØ§Øª Ø³Ø±ÛŒØ¹</h6>
                </div>
                <div class="card-body">
                    {% if contribution.status == 'pending' or contribution.status == 'under_review' %}
                    <form method="post" action="{{ url_for('approve_contribution', contribution_id=contribution.id) }}" class="mb-2">
                        <button type="submit" class="btn btn-success w-100" onclick="return confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')">
                            âœ… ØªØ§ÛŒÛŒØ¯ Ù…Ø´Ø§Ø±Ú©Øª
                        </button>
                    </form>
                    {% endif %}
                    
                    {% if contribution.status != 'rejected' %}
                    <button type="button" class="btn btn-danger w-100" data-bs-toggle="modal" data-bs-target="#rejectModal">
                        âŒ Ø±Ø¯ Ù…Ø´Ø§Ø±Ú©Øª
                    </button>
                    {% endif %}
                </div>
            </div>
            
            <!-- ØªØ¹ÛŒÛŒÙ† Ø§ÙˆÙ„ÙˆÛŒØª -->
            <div class="card mb-4">
                <div class="card-header bg-warning">
                    <h6 class="mb-0">âš ï¸ Ø§ÙˆÙ„ÙˆÛŒØª</h6>
                </div>
                <div class="card-body">
                    <form method="post" action="{{ url_for('set_contribution_priority', contribution_id=contribution.id) }}">
                        <div class="mb-3">
                            <select name="priority" class="form-select" required>
                                <option value="low" {% if contribution.priority == 'low' %}selected{% endif %}>â¬‡ï¸ Ù¾Ø§ÛŒÛŒÙ†</option>
                                <option value="medium" {% if contribution.priority == 'medium' %}selected{% endif %}>â¡ï¸ Ù…ØªÙˆØ³Ø·</option>
                                <option value="high" {% if contribution.priority == 'high' %}selected{% endif %}>âš ï¸ Ø¨Ø§Ù„Ø§</option>
                                <option value="urgent" {% if contribution.priority == 'urgent' %}selected{% endif %}>ğŸ”¥ ÙÙˆØ±ÛŒ</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-warning w-100">ØªØ¹ÛŒÛŒÙ† Ø§ÙˆÙ„ÙˆÛŒØª</button>
                    </form>
                </div>
            </div>
            
            <!-- Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø® -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">âœ‰ï¸ Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®</h6>
                </div>
                <div class="card-body">
                    <form method="post" action="{{ url_for('respond_to_contribution', contribution_id=contribution.id) }}">
                        <div class="mb-3">
                            <label class="form-label">Ù…ØªÙ† Ù¾Ø§Ø³Ø®</label>
                            <textarea name="response" class="form-control" rows="4" required 
                                      placeholder="Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯ Ø¨Ù‡ Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...">{{ contribution.admin_response or '' }}</textarea>
                        </div>
                        <button type="submit" class="btn btn-info w-100">Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®</button>
                    </form>
                </div>
            </div>
            
        </div>
    </div>
    
</div>

<!-- Modal Ø±Ø¯ Ù…Ø´Ø§Ø±Ú©Øª -->
<div class="modal fade" id="rejectModal" tabindex="-1" dir="rtl">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">âŒ Ø±Ø¯ Ù…Ø´Ø§Ø±Ú©Øª</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{{ url_for('reject_contribution', contribution_id=contribution.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Ø¯Ù„ÛŒÙ„ Ø±Ø¯</label>
                        <textarea name="reason" class="form-control" rows="4" required 
                                  placeholder="Ù„Ø·ÙØ§ Ø¯Ù„ÛŒÙ„ Ø±Ø¯ Ø§ÛŒÙ† Ù…Ø´Ø§Ø±Ú©Øª Ø±Ø§ ØªÙˆØ¶ÛŒØ­ Ø¯Ù‡ÛŒØ¯..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
                    <button type="submit" class="btn btn-danger">ØªØ§ÛŒÛŒØ¯ Ø±Ø¯</button>
                </div>
            </form>
        </div>
    </div>
</div>

        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
