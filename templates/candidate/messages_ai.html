<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ - Ù¾Ù†Ù„ Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modern-admin.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='fonts/fontawesome/all.min.css') }}">
    <script src="{{ url_for('static', filename='js/persian-to-english-numbers.js') }}"></script>
    <style>
        .filter-bar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }
        .filter-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 14px;
        }
        .filter-btn:hover {
            background: #f3f4f6;
        }
        .filter-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }
        .category-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .category-complaint {
            background: #fee2e2;
            color: #991b1b;
        }
        .category-question {
            background: #dbeafe;
            color: #1e40af;
        }
        .category-suggestion {
            background: #d1fae5;
            color: #065f46;
        }
        .category-support {
            background: #e0e7ff;
            color: #3730a3;
        }
        .category-criticism {
            background: #fef3c7;
            color: #92400e;
        }
        .priority-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .priority-high {
            background: #fecaca;
            color: #991b1b;
        }
        .priority-medium {
            background: #fed7aa;
            color: #9a3412;
        }
        .priority-low {
            background: #d1fae5;
            color: #065f46;
        }
    </style>
</head>
<body>
    <div class="dashboard-wrapper">
        <!-- Sidebar (same as original) -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-user-tie" style="font-size: 40px;"></i>
                </div>
                <h2>Ù¾Ù†Ù„ Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡</h2>
                <p>{{ candidate.full_name }}</p>
            </div>
            
            <nav class="sidebar-menu">
                <a href="{{ url_for('dashboard') }}" class="menu-item">
                    <i class="fas fa-home"></i>
                    <span>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span>
                </a>
                <a href="{{ url_for('messages') }}" class="menu-item active">
                    <i class="fas fa-envelope"></i>
                    <span>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯</span>
                </a>
                <a href="{{ url_for('logout') }}" class="menu-item" style="margin-top: auto;">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Ø®Ø±ÙˆØ¬</span>
                </a>
            </nav>
        </aside>
        
        <div class="main-content">
            <div class="topbar">
                <div class="topbar-left">
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯</h1>
                </div>
                <div class="topbar-right">
                    <div class="user-profile">
                        <div class="user-avatar">
                            {{ candidate.full_name[0]|upper }}
                        </div>
                        <div class="user-info">
                            <h4>{{ candidate.full_name }}</h4>
                            <p>Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ø§Ù†ØªØ®Ø§Ø¨Ø§ØªÛŒ</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="content-area">
                <div class="page-header">
                    <h2>
                        <i class="fas fa-robot"></i>
                        Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø¨Ø§ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯
                    </h2>
                    <div class="breadcrumb">
                        <span>Ù¾Ù†Ù„ Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡</span>
                        <i class="fas fa-chevron-left"></i>
                        <span>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯</span>
                    </div>
                </div>
                
                <!-- Ø¢Ù…Ø§Ø± -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; padding: 18px; border-radius: 12px;">
                        <p style="margin: 0; opacity: 0.9; font-size: 12px;">Ú©Ù„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§</p>
                        <h3 style="margin: 8px 0 0 0; font-size: 26px;">{{ stats.total }}</h3>
                    </div>
                    <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 18px; border-radius: 12px;">
                        <p style="margin: 0; opacity: 0.9; font-size: 12px;">ï¿½ Ø±Ø¶Ø§ÛŒØª Ù…Ø±Ø¯Ù…</p>
                        <h3 style="margin: 8px 0 0 0; font-size: 26px;">{{ stats.satisfaction_rate }}%</h3>
                    </div>
                    <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 18px; border-radius: 12px;">
                        <p style="margin: 0; opacity: 0.9; font-size: 12px;">ğŸ˜Š Ù…Ø«Ø¨Øª</p>
                        <h3 style="margin: 8px 0 0 0; font-size: 26px;">{{ stats.positive }}</h3>
                    </div>
                    <div style="background: linear-gradient(135deg, #6b7280, #4b5563); color: white; padding: 18px; border-radius: 12px;">
                        <p style="margin: 0; opacity: 0.9; font-size: 12px;">ï¿½ Ø®Ù†Ø«ÛŒ</p>
                        <h3 style="margin: 8px 0 0 0; font-size: 26px;">{{ stats.neutral }}</h3>
                    </div>
                    <div style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 18px; border-radius: 12px;">
                        <p style="margin: 0; opacity: 0.9; font-size: 12px;">ğŸ˜ Ù…Ù†ÙÛŒ</p>
                        <h3 style="margin: 8px 0 0 0; font-size: 26px;">{{ stats.negative }}</h3>
                    </div>
                    <div style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 18px; border-radius: 12px;">
                        <p style="margin: 0; opacity: 0.9; font-size: 12px;">ï¿½ Ø´Ú©Ø§ÛŒØª</p>
                        <h3 style="margin: 8px 0 0 0; font-size: 26px;">{{ stats.complaint }}</h3>
                    </div>
                    <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 18px; border-radius: 12px;">
                        <p style="margin: 0; opacity: 0.9; font-size: 12px;">â“ Ø³ÙˆØ§Ù„</p>
                        <h3 style="margin: 8px 0 0 0; font-size: 26px;">{{ stats.question }}</h3>
                    </div>
                    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 18px; border-radius: 12px;">
                        <p style="margin: 0; opacity: 0.9; font-size: 12px;">âš¡ Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø§Ù„Ø§</p>
                        <h3 style="margin: 8px 0 0 0; font-size: 26px;">{{ stats.high_priority }}</h3>
                    </div>
                </div>
                
                <!-- ÙÛŒÙ„ØªØ±Ù‡Ø§ -->
                <div class="filter-bar">
                    <h4 style="margin: 0 0 15px 0; color: #1f2937;">
                        <i class="fas fa-filter"></i>
                        ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯
                    </h4>
                    
                    <div class="filter-group">
                        <strong style="color: #6b7280;">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ:</strong>
                        <a href="{{ url_for('messages', priority=priority_filter, read=read_filter) }}" 
                           class="filter-btn {% if category_filter == 'all' %}active{% endif %}">
                            Ù‡Ù…Ù‡
                        </a>
                        <a href="{{ url_for('messages', category='complaint', priority=priority_filter, read=read_filter) }}" 
                           class="filter-btn {% if category_filter == 'complaint' %}active{% endif %}">
                            ğŸ”´ Ø´Ú©Ø§ÛŒØª
                        </a>
                        <a href="{{ url_for('messages', category='question', priority=priority_filter, read=read_filter) }}" 
                           class="filter-btn {% if category_filter == 'question' %}active{% endif %}">
                            â“ Ø³ÙˆØ§Ù„
                        </a>
                        <a href="{{ url_for('messages', category='suggestion', priority=priority_filter, read=read_filter) }}" 
                           class="filter-btn {% if category_filter == 'suggestion' %}active{% endif %}">
                            ğŸ’¡ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯
                        </a>
                        <a href="{{ url_for('messages', category='support', priority=priority_filter, read=read_filter) }}" 
                           class="filter-btn {% if category_filter == 'support' %}active{% endif %}">
                            ğŸ‘ Ø­Ù…Ø§ÛŒØª
                        </a>
                        <a href="{{ url_for('messages', category='criticism', priority=priority_filter, read=read_filter) }}" 
                           class="filter-btn {% if category_filter == 'criticism' %}active{% endif %}">
                            ğŸ’¬ Ø§Ù†ØªÙ‚Ø§Ø¯
                        </a>
                    </div>
                    
                    <hr style="margin: 15px 0; border: none; border-top: 1px solid #e5e7eb;">
                    
                    <div class="filter-group">
                        <strong style="color: #6b7280;">Ø§ÙˆÙ„ÙˆÛŒØª:</strong>
                        <a href="{{ url_for('messages', category=category_filter, read=read_filter) }}" 
                           class="filter-btn {% if priority_filter == 'all' %}active{% endif %}">
                            Ù‡Ù…Ù‡
                        </a>
                        <a href="{{ url_for('messages', category=category_filter, priority='high', read=read_filter) }}" 
                           class="filter-btn {% if priority_filter == 'high' %}active{% endif %}">
                            âš¡ Ø¨Ø§Ù„Ø§
                        </a>
                        <a href="{{ url_for('messages', category=category_filter, priority='medium', read=read_filter) }}" 
                           class="filter-btn {% if priority_filter == 'medium' %}active{% endif %}">
                            ğŸŸ¡ Ù…ØªÙˆØ³Ø·
                        </a>
                        <a href="{{ url_for('messages', category=category_filter, priority='low', read=read_filter) }}" 
                           class="filter-btn {% if priority_filter == 'low' %}active{% endif %}">
                            ğŸŸ¢ Ù¾Ø§ÛŒÛŒÙ†
                        </a>
                    </div>
                </div>
                
                <!-- Ù„ÛŒØ³Øª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ -->
                <div class="card">
                    <div class="card-header">
                        <h3>
                            <i class="fas fa-inbox"></i> 
                            {{ messages|length }} Ù¾ÛŒØ§Ù…
                        </h3>
                    </div>
                    <div class="card-body">
                        {% if messages %}
                        <div style="display: grid; gap: 15px;">
                            {% for msg in messages %}
                            <div style="background: {% if not msg.is_read %}#eff6ff{% else %}white{% endif %}; 
                                        border: 2px solid {% if not msg.is_read %}#3b82f6{% else %}#e5e7eb{% endif %}; 
                                        border-radius: 12px; padding: 20px;">
                                <div style="display: flex; justify-content: space-between; gap: 15px;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                            <h4 style="margin: 0; color: #1f2937;">
                                                {{ msg.user_name or 'Ú©Ø§Ø±Ø¨Ø± ØªÙ„Ú¯Ø±Ø§Ù…' }}
                                            </h4>
                                            
                                            {% if msg.category %}
                                            <span class="category-badge category-{{ msg.category }}">
                                                {{ msg.category_fa }}
                                            </span>
                                            {% endif %}
                                            
                                            {% if msg.category_priority %}
                                            <span class="priority-badge priority-{{ msg.category_priority }}">
                                                Ø§ÙˆÙ„ÙˆÛŒØª {{ 'Ø¨Ø§Ù„Ø§' if msg.category_priority == 'high' else 'Ù…ØªÙˆØ³Ø·' if msg.category_priority == 'medium' else 'Ù¾Ø§ÛŒÛŒÙ†' }}
                                            </span>
                                            {% endif %}
                                            
                                            {% if msg.category_confidence %}
                                            <span style="font-size: 11px; color: #6b7280;">
                                                (Ø§Ø·Ù…ÛŒÙ†Ø§Ù†: {{ (msg.category_confidence * 100)|int }}%)
                                            </span>
                                            {% endif %}
                                            
                                            {% if msg.sentiment_label %}
                                            <span style="padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;
                                                         background: {% if msg.sentiment_label == 'positive' %}#d1fae5; color: #065f46{% elif msg.sentiment_label == 'negative' %}#fee2e2; color: #991b1b{% else %}#f3f4f6; color: #6b7280{% endif %};">
                                                {% if msg.sentiment_label == 'positive' %}ğŸ˜Š Ù…Ø«Ø¨Øª{% elif msg.sentiment_label == 'negative' %}ğŸ˜ Ù…Ù†ÙÛŒ{% else %}ğŸ˜ Ø®Ù†Ø«ÛŒ{% endif %}
                                            </span>
                                            {% endif %}
                                        </div>
                                        
                                        <p style="margin: 0 0 10px 0; color: #4b5563; line-height: 1.6;">
                                            {{ msg.message_text }}
                                        </p>
                                        
                                        <p style="margin: 0; color: #9ca3af; font-size: 13px;">
                                            <i class="fas fa-clock"></i>
                                            {{ msg.created_at.strftime('%Y/%m/%d - %H:%M') }}
                                        </p>
                                    </div>
                                    
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        {% if not msg.is_read %}
                                        <button onclick="markRead({{ msg.id }})" 
                                                style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                            <i class="fas fa-check"></i>
                                            Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯
                                        </button>
                                        {% else %}
                                        <span style="padding: 8px 16px; background: #e5e7eb; color: #6b7280; border-radius: 8px; text-align: center;">
                                            <i class="fas fa-check-double"></i>
                                            Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯Ù‡
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                            <i class="fas fa-inbox" style="font-size: 60px; margin-bottom: 20px; opacity: 0.3;"></i>
                            <p style="font-size: 18px; margin: 0;">Ù¾ÛŒØ§Ù…ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function markRead(messageId) {
            fetch(`/message/${messageId}/read`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
        }
    </script>
</body>
</html>
