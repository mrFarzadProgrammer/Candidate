<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لیست نمایندهها</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modern-admin.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='fonts/fontawesome/all.min.css') }}">
    <script src="{{ url_for('static', filename='js/persian-to-english-numbers.js') }}"></script>
</head>
<body>
    <div class="dashboard-wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo"><i class="fas fa-vote-yea"></i></div>
                <h2>پنل مدیریت</h2>
                <p>سامانه باتهای انتخاباتی</p>
            </div>
            <nav class="sidebar-menu">
                <a href="{{ url_for('dashboard') }}" class="menu-item"><i class="fas fa-chart-line"></i><span>داشبورد</span></a>
                <a href="{{ url_for('candidates') }}" class="menu-item active"><i class="fas fa-users"></i><span>نمایندگان</span></a>
                <a href="{{ url_for('plans') }}" class="menu-item"><i class="fas fa-tags"></i><span>پلن‌ها</span></a>
                <a href="{{ url_for('subscriptions') }}" class="menu-item"><i class="fas fa-shopping-cart"></i><span>اشتراک‌ها</span></a>
                <a href="{{ url_for('referral_rewards') }}" class="menu-item"><i class="fas fa-gift"></i><span>پاداش‌های معرفی</span></a>
                <a href="{{ url_for('logout') }}" class="menu-item"><i class="fas fa-sign-out-alt"></i><span>خروج</span></a>
            </nav>
        </aside>
        <main class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="sidebar-toggle"><i class="fas fa-bars"></i></button>
                    <h1>لیست نمایندهها</h1>
                </div>
                <div class="topbar-right">
                    <div class="user-profile"><i class="fas fa-user-circle"></i><span>مدیر سیستم</span></div>
                </div>
            </header>
            <div class="content-area">
                <div class="page-header">
                    <h2><i class="fas fa-users"></i> مدیریت نمایندهها ({{ candidates|length }} نفر)</h2>
                    <a href="{{ url_for('create_candidate') }}" class="btn btn-primary"><i class="fas fa-plus"></i> افزودن نماینده</a>
                </div>
                
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }}" style="margin-bottom:20px;">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                {% if candidates %}
                <!-- Search Box -->
                <div class="card" style="margin-bottom:20px;">
                    <div class="card-body" style="padding:20px;">
                        <div style="display:flex;align-items:center;gap:15px;">
                            <i class="fas fa-search" style="font-size:20px;color:#667eea;"></i>
                            <input type="text" id="searchInput" class="form-control" placeholder="جستجو در نام، نام خانوادگی، استان، شهر، تلفن، یوزرنیم بات..." style="flex:1;padding:12px 20px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;">
                        </div>
                    </div>
                </div>
                
                <!-- Table -->
                <div class="card">
                    <div class="table-responsive">
                        <table class="data-table" id="candidatesTable">
                            <thead>
                                <tr>
                                    <th style="width:60px;">شناسه</th>
                                    <th>نام کامل</th>
                                    <th>استان</th>
                                    <th>شهر</th>
                                    <th>تلفن</th>
                                    <th>بات تلگرام</th>
                                    <th>وضعیت بات</th>
                                    <th style="width:200px;">عملیات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for candidate in candidates %}
                                <tr>
                                    <td><span style="background:#f3f4f6;padding:5px 10px;border-radius:6px;font-weight:600;">{{ candidate.id }}</span></td>
                                    <td>
                                        <div class="user-info" style="display:flex;align-items:center;gap:10px;">
                                            <div class="avatar-gradient" style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:16px;">
                                                {{ candidate.full_name[0]|upper }}
                                            </div>
                                            <div>
                                                <strong style="display:block;color:#1e293b;">{{ candidate.full_name }} {{ candidate.last_name or '' }}</strong>
                                                <small style="color:#64748b;">@{{ candidate.username }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ candidate.province or '-' }}</td>
                                    <td>{{ candidate.city or '-' }}</td>
                                    <td><span style="font-family:monospace;background:#f1f5f9;padding:4px 8px;border-radius:4px;font-size:13px;">{{ candidate.phone or '-' }}</span></td>
                                    <td>
                                        {% if candidate.bot_instance %}
                                            <a href="https://t.me/{{ candidate.bot_instance.bot_username }}" target="_blank" style="color:#667eea;text-decoration:none;font-weight:600;">
                                                <i class="fab fa-telegram"></i> @{{ candidate.bot_instance.bot_username }}
                                            </a>
                                        {% else %}
                                            <span style="color:#94a3b8;">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if candidate.bot_instance and candidate.bot_instance.is_active %}
                                            <span style="background:#dcfce7;color:#16a34a;padding:5px 12px;border-radius:6px;font-size:13px;font-weight:600;">
                                                <i class="fas fa-check-circle"></i> فعال
                                            </span>
                                        {% elif candidate.bot_instance %}
                                            <span style="background:#fee2e2;color:#dc2626;padding:5px 12px;border-radius:6px;font-size:13px;font-weight:600;">
                                                <i class="fas fa-times-circle"></i> غیرفعال
                                            </span>
                                        {% else %}
                                            <span style="background:#fef3c7;color:#d97706;padding:5px 12px;border-radius:6px;font-size:13px;font-weight:600;">
                                                <i class="fas fa-exclamation-triangle"></i> بدون بات
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="action-buttons" style="display:flex;gap:8px;justify-content:flex-start;flex-wrap:wrap;">
                                            {% if not candidate.has_used_trial %}
                                            <form method="POST" action="{{ url_for('activate_trial', id=candidate.id) }}" style="display:inline;" onsubmit="return confirm('فعال‌سازی Trial 3 روزه رایگان برای {{ candidate.full_name }}؟');">
                                                <button type="submit" class="btn btn-sm" title="Trial 3 روزه" 
                                                        style="padding:6px 12px;background:linear-gradient(135deg,#f59e0b,#ea580c);color:white;border:none;">
                                                    <i class="fas fa-gift"></i>
                                                </button>
                                            </form>
                                            {% endif %}
                                            <a href="{{ url_for('grant_free_plan', id=candidate.id) }}" class="btn btn-sm" title="اعطای رایگان" 
                                               style="padding:6px 12px;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;">
                                                <i class="fas fa-hand-holding-usd"></i>
                                            </a>
                                            <a href="{{ url_for('setup_bot', candidate_id=candidate.id) }}" class="btn btn-sm btn-info" title="تنظیمات بات" style="padding:6px 12px;">
                                                <i class="fas fa-robot"></i>
                                            </a>
                                            <a href="{{ url_for('edit_candidate', candidate_id=candidate.id) }}" class="btn btn-sm btn-success" title="ویرایش" style="padding:6px 12px;">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <form method="POST" action="{{ url_for('delete_candidate', candidate_id=candidate.id) }}" style="display:inline;" onsubmit="return confirm('آیا از حذف {{ candidate.full_name }} مطمئن هستید؟\n\nتوجه: بات و تمام اطلاعات مرتبط نیز حذف خواهند شد.');">
                                                <button type="submit" class="btn btn-sm btn-danger" title="حذف" style="padding:6px 12px;">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <div class="empty-state" style="text-align:center;padding:60px 20px;">
                    <div class="empty-icon" style="font-size:80px;color:#e5e7eb;margin-bottom:20px;">
                        <i class="fas fa-users-slash"></i>
                    </div>
                    <h3 style="color:#475569;margin-bottom:10px;">هیچ نمایندهای ثبت نشده</h3>
                    <p style="color:#94a3b8;margin-bottom:30px;">برای شروع اولین نماینده خود را اضافه کنید</p>
                    <a href="{{ url_for('create_candidate') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> افزودن نماینده
                    </a>
                </div>
                {% endif %}
            </div>
        </main>
    </div>
    <script>
        document.querySelector('.sidebar-toggle').addEventListener('click', function() {
            document.querySelector('.sidebar').classList.toggle('active');
        });
        
        // Search functionality
        document.getElementById('searchInput').addEventListener('keyup', function() {
            const searchText = this.value.toLowerCase();
            const table = document.getElementById('candidatesTable');
            const rows = table.getElementsByTagName('tr');
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const text = row.textContent.toLowerCase();
                
                if (text.includes(searchText)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });
    </script>
</body>
</html>
